<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Moka — Menù Categoria</title>
  
  <link rel="stylesheet" href="menu.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root {
      --primary-dark: #2c3e50;
      --accent-moka: #e74c3c;
      --bg-app: #f8f9fa;
    }

    body { 
      background-color: var(--bg-app); 
      font-family: 'Inter', sans-serif;
      padding-bottom: 80px;
    }

    /* Riga 1: Torna indietro (Separata con bordi) */
    .nav-row-back {
      background: #fff;
      border-top: 1px solid #dee2e6;
      border-bottom: 1px solid #dee2e6;
      padding: 12px 0;
      text-align: center;
      margin-top: 5px;
    }

    .btn-back-full {
      color: #7f8c8d;
      text-decoration: none;
      font-size: 0.85rem;
      font-weight: 600;
      transition: color 0.2s;
    }
    .btn-back-full:hover { color: var(--accent-moka); }

    /* Riga 2: Titolo Categoria (Separata con bordi) */
    .nav-row-title {
      background: #fff;
      border-bottom: 2px solid #eee;
      padding: 15px 0;
      text-align: center;
      margin-bottom: 15px;
    }

    .category-main-title {
      font-weight: 800;
      font-size: 1.7rem;
      color: var(--primary-dark);
      margin: 0;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    /* Pills Sottocategorie Centrate */
    .subcategory-pills-container {
      overflow-x: auto;
      white-space: nowrap;
      padding: 5px 0 20px;
      scrollbar-width: none;
      text-align: center;
    }
    .subcategory-pills-container::-webkit-scrollbar { display: none; }
    
    .pill-link {
      background: white;
      border: 1px solid #ddd;
      padding: 8px 20px;
      border-radius: 25px;
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--primary-dark);
      text-decoration: none;
      margin: 0 5px;
      display: inline-block;
    }
    .pill-link.active {
      background: var(--accent-moka);
      color: white;
      border-color: var(--accent-moka);
    }

    /* Stile Sottocategoria Titolo: BLU SCURO */
    .subcategory-header-btn {
      width: 100%;
      background: var(--primary-dark);
      color: white;
      border: none;
      padding: 14px 20px;
      border-radius: 12px;
      font-weight: 800;
      text-transform: uppercase;
      margin-bottom: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      pointer-events: none;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }

    /* Card Piatto Professionale */
    .dish-card {
      background: white;
      border-radius: 18px;
      border: none;
      box-shadow: 0 4px 15px rgba(0,0,0,0.04);
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 15px;
    }

    .dish-name { font-weight: 700; font-size: 1.1rem; color: #1a1a1a; }
    .dish-price { font-weight: 800; font-size: 1.2rem; color: #2ecc71; }

    .btn-add-cart {
      background: var(--accent-moka);
      color: white;
      border: none;
      width: 42px;
      height: 42px;
      border-radius: 14px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
  </style>
</head>
<body class="menu-page">

  <!-- HEADER IDENTICO A MENU.HTML -->
  <div class="header">
    <div class="container">
      <div class="row py-2">
        <div class="col-12 text-center">
          <h1 class="h5 mb-0"><i class="fas fa-utensils me-2"></i>RistoranteMoka</h1>
        </div>
      </div>
      <div class="row py-1 align-items-center flex-nowrap">
        <div class="col-6 d-flex align-items-center">
          <i class="fas fa-table me-1"></i>
          <span class="fw-semibold">Tavolo: <span id="tavolo-numero">--</span></span>
        </div>
        <div class="col-6 d-flex justify-content-end align-items-center">
          <div class="d-flex align-items-center" style="max-width:260px; overflow:hidden; white-space:nowrap; text-overflow:ellipsis;">
            <span id="cliente-corrente-letter" class="badge bg-primary me-2">-</span>
            <span id="cliente-corrente-nome" class="text-truncate">--</span>
          </div>
        </div>
      </div>
      <div class="row py-1">
        <div class="col-6 d-flex align-items-center">
          <button id="btn-apri-bevande-unico" class="btn btn-bevande btn-sm me-2" type="button">
            <i class="fas fa-wine-glass-alt me-1"></i> Ordina bevande
          </button>
        </div>
        <div class="col-6 d-flex justify-content-end">
          <button id="btn-visualizza-ordini" class="btn btn-ordini btn-sm" type="button">
            <i class="fas fa-history me-1"></i> I tuoi ordini
          </button>
        </div>
      </div>
    </div>
  </div>

  <div class="nav-row-back shadow-sm">
    <div class="container">
      <a href="#" id="btn-back-dynamic" class="btn-back-full">
        <i class="fas fa-chevron-left me-2"></i> Torna indietro al Menu principale
      </a>
    </div>
  </div>

  <div class="nav-row-title shadow-sm">
    <div class="container">
      <h2 id="page-context-title" class="category-main-title">Caricamento...</h2>
    </div>
  </div>

  <main class="container">
    <div id="subcategory-nav" class="subcategory-pills-container"></div>
    <div id="menu-container">
      <div class="text-center py-5">
        <div class="spinner-border text-danger" role="status"></div>
      </div>
    </div>
  </main>

  <!-- SCRIPTS: Caricamento sequenziale esatto come in menu.html -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="inizializza/js/state.js"></script>
  <script src="inizializza/js/state-shim.js"></script>
  <script src="inizializza/js/cart-ui.js"></script>
  <script src="inizializza/js/api-service.js"></script>
  <script src="menu.js"></script>

  <script>
    (function () {
      const qs = new URLSearchParams(window.location.search);
      const macroParam = qs.get('macro') || '';

      // Back button dinamico
      document.getElementById('btn-back-dynamic').onclick = (e) => {
        e.preventDefault();
        const currentParams = new URLSearchParams(window.location.search);
        currentParams.delete('macro');
        window.location.href = 'menu.html?' + currentParams.toString();
      };

      // FORZATURA NOME: Cerca nel localStorage o nell'URL
      function forceSyncName() {
        const nomeUrl = qs.get('nome_cliente'); // Se lo passi nell'URL
        const tavolo = qs.get('tavolo');
        const sessione = qs.get('sessione');
        
        if (nomeUrl) {
          document.getElementById('cliente-corrente-nome').textContent = decodeURIComponent(nomeUrl);
          document.getElementById('cliente-corrente-letter').textContent = nomeUrl.charAt(0).toUpperCase();
        } else {
          // Prova a leggere come fa state.js
          const key = sessione ? 'cliente_sessione_' + sessione : (tavolo ? 'cliente_tavolo_' + tavolo : null);
          const saved = JSON.parse(localStorage.getItem(key));
          if (saved && saved.nome) {
            document.getElementById('cliente-corrente-nome').textContent = saved.nome;
            document.getElementById('cliente-corrente-letter').textContent = saved.lettera || saved.nome.charAt(0).toUpperCase();
          }
        }
        // Sync numero tavolo
        if (tavolo) document.getElementById('tavolo-numero').textContent = tavolo;
      }

      async function init() {
        forceSyncName();
        try {
          const resp = await fetch('../api/menu/menu.php');
          const data = await resp.json();
          const macros = (data.data || []).map(c => {
            let subs = (c.sottocategorie || [])
              .filter(sub => sub.visibile != 0)
              .map(sub => ({ nome: sub.nome, piatti: sub.piatti || [] }));
            if (c.piatti && c.piatti.length) {
              subs.unshift({ nome: `${c.nome} Classici`, piatti: c.piatti });
            }
            return { nome: c.nome, sottocategorie: subs };
          });
          
          const found = macros.find(m => m.nome.toLowerCase() === macroParam.toLowerCase());
          if (found) render(found);
        } catch (e) { console.error(e); }
      }

      function render(macro) {
        document.getElementById('page-context-title').textContent = macro.nome;
        const nav = document.getElementById('subcategory-nav');
        const container = document.getElementById('menu-container');
        container.innerHTML = '';
        
        macro.sottocategorie.forEach((sub, idx) => {
          const pill = document.createElement('a');
          pill.className = `pill-link ${idx === 0 ? 'active' : ''}`;
          pill.textContent = sub.nome;
          pill.href = `#sub-${idx}`;
          pill.onclick = () => {
            document.querySelectorAll('.pill-link').forEach(p => p.classList.remove('active'));
            pill.classList.add('active');
          };
          nav.appendChild(pill);

          const sec = document.createElement('section');
          sec.id = `sub-${idx}`;
          sec.className = "mb-5";
          sec.innerHTML = `<div class="subcategory-header-btn"><span>${sub.nome}</span><i class="fas fa-chevron-right small"></i></div>`;
          
          sub.piatti.forEach(p => {
            const div = document.createElement('div');
            div.className = "dish-card";
            div.innerHTML = `
              <div class="dish-info">
                <div class="dish-name">${p.nome}</div>
                <div class="dish-description text-muted small">${p.descrizione || ''}</div>
                <div class="mt-2">
                  ${p.tempo_preparazione ? `<span class="badge bg-light text-dark border me-1">${p.tempo_preparazione}m</span>` : ''}
                  ${p.punti_fedelta ? `<span class="badge bg-light text-warning border">${p.punti_fedelta}pt</span>` : ''}
                </div>
              </div>
              <div class="text-end">
                <div class="dish-price">€${parseFloat(p.prezzo).toFixed(2)}</div>
                <button class="btn-add-cart mt-2" onclick="aggiungereAlCarrello(${p.id}, '${p.nome.replace(/'/g, "\\'")}', ${p.prezzo})">
                  <i class="fas fa-plus"></i>
                </button>
              </div>`;
            sec.appendChild(div);
          });
          container.appendChild(sec);
        });
      }

      window.addEventListener('load', init);
    })();
  </script>
</body>
</html>