//menu-categoria.html
<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Menu â€” Categoria</title>
  <link rel="stylesheet" href="./app/menu.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js" defer></script>
  <!-- Assumiamo che app/menu.js sia presente e fornisca mostrareCategoriaView e mostrareMacrocategorie -->
  <script src="./app/menu.js" defer></script>
  <style>
    /* piccoli adattamenti per questa pagina */
    body { background: #f5f7fa; padding-bottom: 40px; }
    .container { max-width: 900px; margin: 20px auto; }
  </style>
</head>
<body>
  <div class="container">
    <div id="topbar" class="d-flex align-items-center mb-3">
      <a href="./app/menu.html" id="btn-back-to-menu" class="btn btn-outline-secondary btn-sm me-3">
        <i class="fas fa-arrow-left me-1"></i> Torna al Menu
      </a>
      <h4 id="page-title" style="margin:0;">Categoria</h4>
    </div>

    <div id="menu" class="menu-page">
      <div id="loading" style="text-align:center; padding:40px;">
        <div class="spinner-border text-primary" role="status"></div>
        <p class="mt-3">Caricamento categoria...</p>
      </div>
    </div>
  </div>

  <script>
    (function () {
      const qs = new URLSearchParams(window.location.search);
      const macroParam = qs.get('macro') || '';
      const normalized = (s) => (s || '').toString().trim().toLowerCase();

      async function fetchMenu() {
        try {
          const resp = await fetch('../api/menu/menu.php');
          const data = await resp.json();
          if (!(data && data.success)) {
            document.getElementById('menu').innerHTML = '<div class="alert alert-danger">Errore nel caricamento del menu</div>';
            return null;
          }
          return data.data;
        } catch (e) {
          document.getElementById('menu').innerHTML = '<div class="alert alert-danger">Errore di connessione</div>';
          return null;
        }
      }

      // Ricostruisce la struttura "macrocategorie" seguendo la stessa logica di app/menu.js
      // Export to window for reuse
      window.buildMacrosFrom = function buildMacrosFrom(categories) {
        if (!Array.isArray(categories)) return [];
        const looksLikeMacros = categories.every(c => c && (Array.isArray(c.sottocategorie) || Array.isArray(c.subcategories) || Array.isArray(c.children) || Array.isArray(c.categorie)));
        if (looksLikeMacros) return categories.slice();

        const hasMacroField = categories.some(c => c && typeof c.macro === 'string' && c.macro.trim().length > 0);
        if (hasMacroField) {
          const map = {};
          categories.forEach(c => {
            const macroName = (c && c.macro) ? String(c.macro).trim() : 'Altro';
            map[macroName] = map[macroName] || { nome: macroName, sottocategorie: [] };
            map[macroName].sottocategorie.push(c);
          });
          return Object.keys(map).map(k => map[k]);
        }

        // Fallback: raggruppa tutte le categorie sotto un unico macro "Menu"
        const wrapperMacro = { nome: 'Menu', sottocategorie: [] };
        categories.forEach(c => {
          const sub = {
            nome: c.nome || c.titolo || 'Categoria',
            piatti: Array.isArray(c.piatti) ? c.piatti : (c.items || [])
          };
          wrapperMacro.sottocategorie.push(sub);
        });
        return [ wrapperMacro ];
      };

      async function init() {
        const raw = await fetchMenu();
        if (!raw) return;

        const macros = buildMacrosFrom(raw);
        window._menu_macros = macros;

        if (!macroParam) {
          // se nessun parametro, mostra lista macrocategorie
          try { if (typeof mostrareMacrocategorie === 'function') mostrareMacrocategorie(macros); else document.getElementById('menu').innerText = 'Nessuna macro selezionata.'; } catch(e){ console.warn(e); }
          return;
        }

        // trova macro per nome (case-insensitive) o per titolo
        const found = macros.find(m => normalized(m.nome || m.titolo) === normalized(macroParam) || normalized(m.nome || m.titolo).includes(normalized(macroParam)));
        if (found) {
          // imposta titolo pagina
          try { document.getElementById('page-title').textContent = found.nome || found.titolo || 'Categoria'; } catch(e){}
          try {
            // usa la funzione esistente per renderizzare la vista categoria
            if (typeof mostrareCategoriaView === 'function') {
              mostrareCategoriaView(found);
            } else {
              // fallback: render semplice
              const cont = document.getElementById('menu');
              cont.innerHTML = '';
              const card = document.createElement('div');
              card.className = 'card';
              const header = document.createElement('div');
              header.className = 'card-header';
              header.textContent = found.nome || found.titolo || 'Categoria';
              card.appendChild(header);
              const body = document.createElement('div');
              body.className = 'card-body';
              if (Array.isArray(found.sottocategorie)) {
                found.sottocategorie.forEach(sub => {
                  const s = document.createElement('div');
                  s.className = 'mb-3';
                  const h = document.createElement('h6');
                  h.textContent = sub.nome || sub.titolo || 'Sottocategoria';
                  s.appendChild(h);
                  if (Array.isArray(sub.piatti) && sub.piatti.length) {
                    const ul = document.createElement('div');
                    sub.piatti.forEach(p => {
                      const el = document.createElement('div');
                      el.className = 'piatto-item';
                      el.textContent = p.nome || p.titolo || 'Piatto';
                      ul.appendChild(el);
                    });
                    s.appendChild(ul);
                  } else {
                    const none = document.createElement('div');
                    none.className = 'text-muted';
                    none.textContent = 'Nessun piatto in questa sottocategoria';
                    s.appendChild(none);
                  }
                  body.appendChild(s);
                });
              } else {
                body.innerHTML = '<div class="text-muted">Nessuna sottocategoria disponibile</div>';
              }
              card.appendChild(body);
              cont.appendChild(card);
            }
          } catch (e) {
            console.warn('Errore rendering categoria:', e);
          }
        } else {
          // macro non trovata: mostra elenco macros come fallback
          try { mostrareMacrocategorie(macros); } catch(e) { document.getElementById('menu').innerHTML = '<div class="alert alert-warning">Categoria non trovata</div>'; }
        }
      }

      window.addEventListener('load', init);
    })();
  </script>
</body>
</html>