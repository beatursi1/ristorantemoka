<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analisi Progetto con Claude - Ristorante Moka</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
        }
        body {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .container {
            max-width: 1200px;
            width: 100%;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 90vh;
        }
        header {
            background: #2d3748;
            color: white;
            padding: 20px 30px;
        }
        header h1 {
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        header p {
            color: #cbd5e0;
            font-size: 0.95rem;
        }
        .main-content {
            display: flex;
            flex: 1;
            overflow: hidden;
        }
        .sidebar {
            width: 300px;
            background: #f7fafc;
            border-right: 1px solid #e2e8f0;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 20px;
            overflow-y: auto;
        }
        .upload-area {
            background: white;
            border: 2px dashed #cbd5e0;
            border-radius: 10px;
            padding: 20px;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-area:hover {
            border-color: #667eea;
            background: #faf5ff;
        }
        .upload-area.dragover {
            border-color: #48bb78;
            background: #f0fff4;
        }
        .upload-icon {
            font-size: 40px;
            margin-bottom: 10px;
            color: #a0aec0;
        }
        .file-list {
            flex: 1;
            background: white;
            border-radius: 10px;
            padding: 15px;
            overflow-y: auto;
        }
        .file-list h3 {
            margin-bottom: 15px;
            color: #2d3748;
            font-size: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .file-item {
            display: flex;
            align-items: center;
            padding: 8px 10px;
            background: #edf2f7;
            margin-bottom: 5px;
            border-radius: 6px;
            font-size: 0.9rem;
            word-break: break-all;
        }
        .file-item .icon {
            margin-right: 8px;
            font-size: 1.1rem;
        }
        .file-count {
            margin-top: 10px;
            color: #718096;
            font-size: 0.85rem;
            text-align: center;
        }
        .model-selector {
            background: white;
            border-radius: 10px;
            padding: 15px;
        }
        .model-selector label {
            display: block;
            margin-bottom: 8px;
            color: #4a5568;
            font-weight: 500;
        }
        .model-selector select {
            width: 100%;
            padding: 10px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: white;
            font-size: 0.95rem;
        }
        .chat-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: white;
        }
        .messages {
            flex: 1;
            padding: 25px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .message {
            max-width: 80%;
            padding: 12px 18px;
            border-radius: 18px;
            line-height: 1.5;
            font-size: 0.95rem;
            white-space: pre-wrap;
        }
        .message.user {
            align-self: flex-end;
            background: #667eea;
            color: white;
            border-bottom-right-radius: 4px;
        }
        .message.assistant {
            align-self: flex-start;
            background: #edf2f7;
            color: #1a202c;
            border-bottom-left-radius: 4px;
        }
        .message.assistant p {
            margin: 0 0 10px 0;
        }
        .message.assistant p:last-child {
            margin-bottom: 0;
        }
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 18px;
            background: #edf2f7;
            border-radius: 18px;
            border-bottom-left-radius: 4px;
            width: fit-content;
        }
        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: #718096;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }
        .typing-indicator span:nth-child(1) { animation-delay: -0.32s; }
        .typing-indicator span:nth-child(2) { animation-delay: -0.16s; }
        @keyframes bounce {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }
        .input-area {
            padding: 20px 25px;
            border-top: 1px solid #e2e8f0;
            display: flex;
            gap: 15px;
            background: #f8fafd;
        }
        .input-area textarea {
            flex: 1;
            padding: 12px 15px;
            border: 1px solid #e2e8f0;
            border-radius: 25px;
            resize: none;
            font-size: 0.95rem;
            font-family: inherit;
            outline: none;
            transition: border 0.2s;
            max-height: 120px;
            min-height: 50px;
        }
        .input-area textarea:focus {
            border-color: #667eea;
        }
        .input-area button {
            padding: 0 30px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 1rem;
            height: 50px;
            align-self: flex-end;
        }
        .input-area button:hover:not(:disabled) {
            background: #5a67d8;
        }
        .input-area button:disabled {
            background: #cbd5e0;
            cursor: not-allowed;
        }
        .clear-btn {
            background: #fc8181 !important;
        }
        .clear-btn:hover:not(:disabled) {
            background: #f56565 !important;
        }
        footer {
            padding: 12px 30px;
            background: #edf2f7;
            color: #718096;
            font-size: 0.85rem;
            text-align: center;
            border-top: 1px solid #e2e8f0;
        }
    </style>
    <!-- 1. Includi Puter.js -->
    <script src="https://js.puter.com/v2/"></script>
</head>
<body>
    <div class="container">
        <header>
            <h1>‚òï Ristorante Moka - Analisi Progetti con Claude</h1>
            <p>Carica i file del tuo progetto e chatta con Claude per analisi, debugging e suggerimenti.</p>
        </header>

        <div class="main-content">
            <!-- Sidebar sinistra per upload file -->
            <div class="sidebar">
                <div class="upload-area" id="uploadArea">
                    <div class="upload-icon">üìÅ</div>
                    <p><strong>Clicca o trascina</strong> qui i file</p>
                    <p style="font-size: 0.8rem; color: #718096; margin-top: 8px;">Puoi selezionare pi√π file contemporaneamente</p>
                    <input type="file" id="fileInput" multiple style="display: none;">
                </div>

                <div class="file-list">
                    <h3>üìã File del progetto</h3>
                    <div id="fileListContainer">
                        <p style="color: #a0aec0; text-align: center; padding: 20px 0;">Nessun file caricato</p>
                    </div>
                    <div class="file-count" id="fileCount">0 file</div>
                </div>

                <div class="model-selector">
                    <label for="modelSelect">ü§ñ Modello Claude:</label>
                    <select id="modelSelect">
                        <option value="claude-3-7-sonnet" selected>Claude 3.7 Sonnet (bilanciato)</option>
                        <option value="claude-opus-4">Claude Opus 4 (pi√π potente)</option>
                        <option value="claude-sonnet-4">Claude Sonnet 4</option>
                        <option value="claude-3-5-sonnet">Claude 3.5 Sonnet</option>
                    </select>
                </div>
            </div>

            <!-- Area chat principale -->
            <div class="chat-area">
                <div class="messages" id="messagesContainer">
                    <div class="message assistant">
                        Ciao! Sono Claude. Sono qui per analizzare il tuo progetto. <br><br>
                        <strong>Come funziona:</strong><br>
                        1. Carica i file del progetto dal pannello di sinistra<br>
                        2. Scrivimi cosa vuoi sapere (es. "Analizza l'architettura", "Trova bug", "Suggerisci miglioramenti")<br>
                        3. Invier√≤ automaticamente tutti i file come contesto
                    </div>
                </div>

                <div class="input-area">
                    <textarea id="userInput" placeholder="Chiedimi qualcosa sul progetto... (es. 'Analizza questo codice' o 'Trova potenziali bug')" rows="2"></textarea>
                    <button id="sendButton" onclick="sendMessage()">Invia</button>
                    <button id="clearButton" class="clear-btn" onclick="clearChat()" title="Nuova chat">üóëÔ∏è</button>
                </div>
            </div>
        </div>

        <footer>
            ‚ö° Le richieste usano i crediti del tuo account Puter. Autenticazione gestita automaticamente.
        </footer>
    </div>

    <script>
        // --- Stato dell'applicazione ---
        let projectFiles = [];  // Array di oggetti File
        let isProcessing = false;
        let currentTypingIndicator = null;

        // --- Elementi DOM ---
        const uploadArea = document.getElementById('uploadArea');
        const fileInput = document.getElementById('fileInput');
        const fileListContainer = document.getElementById('fileListContainer');
        const fileCount = document.getElementById('fileCount');
        const messagesContainer = document.getElementById('messagesContainer');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const modelSelect = document.getElementById('modelSelect');

        // --- Gestione Upload File (Drag & Drop e click) ---
        uploadArea.addEventListener('click', () => fileInput.click());

        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('dragover');
        });

        uploadArea.addEventListener('dragleave', () => {
            uploadArea.classList.remove('dragover');
        });

        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            handleFiles(files);
        });

        fileInput.addEventListener('change', (e) => {
            const files = Array.from(e.target.files);
            handleFiles(files);
            // Reset input per permettere di ricaricare gli stessi file se necessario
            fileInput.value = '';
        });

        function handleFiles(newFiles) {
            // Filtra eventuali duplicati (confronto per nome e dimensione)
            const uniqueNewFiles = newFiles.filter(newFile => 
                !projectFiles.some(existingFile => 
                    existingFile.name === newFile.name && existingFile.size === newFile.size
                )
            );

            if (uniqueNewFiles.length === 0) {
                alert('Questi file sono gi√† stati caricati.');
                return;
            }

            projectFiles = [...projectFiles, ...uniqueNewFiles];
            updateFileList();
            addMessageToChat('assistant', `‚úÖ Aggiunti ${uniqueNewFiles.length} file. Totale: ${projectFiles.length} file. Ora puoi farmi domande sul progetto.`);
        }

        function updateFileList() {
            if (projectFiles.length === 0) {
                fileListContainer.innerHTML = '<p style="color: #a0aec0; text-align: center; padding: 20px 0;">Nessun file caricato</p>';
                fileCount.textContent = '0 file';
                return;
            }

            let html = '';
            projectFiles.forEach((file, index) => {
                const icon = getFileIcon(file.name);
                const size = (file.size / 1024).toFixed(1);
                html += `<div class="file-item" title="${file.name} (${size} KB)">
                    <span class="icon">${icon}</span>
                    <span>${file.name.length > 30 ? file.name.substring(0, 27) + '...' : file.name}</span>
                </div>`;
            });
            fileListContainer.innerHTML = html;
            fileCount.textContent = `${projectFiles.length} file`;
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const icons = {
                js: 'üü®', html: 'üü•', css: 'üü¶', json: 'üì¶', md: 'üìò',
                py: 'üêç', java: '‚òï', cpp: '‚öôÔ∏è', txt: 'üìÑ', php: 'üêò',
                xml: 'üì∞', yml: 'üîß', yaml: 'üîß', sh: 'üêö', sql: 'üóÑÔ∏è'
            };
            return icons[ext] || 'üìÑ';
        }

        // --- Gestione Chat ---
        async function sendMessage() {
            const userMessage = userInput.value.trim();
            if (!userMessage && projectFiles.length === 0) {
                alert('Scrivi un messaggio o carica dei file.');
                return;
            }
            if (isProcessing) return;

            // Mostra messaggio utente
            addMessageToChat('user', userMessage || '(analisi senza domanda specifica)');
            userInput.value = '';
            userInput.style.height = 'auto';

            // Disabilita input durante l'elaborazione
            setProcessingState(true);

            // Mostra indicatore di digitazione
            showTypingIndicator();

            try {
                // Costruisci il contesto con TUTTI i file del progetto
                let contesto = '';
                if (projectFiles.length > 0) {
                    contesto = "Ecco i file del mio progetto per l'analisi:\n\n";
                    
                    for (const file of projectFiles) {
                        const contenuto = await readFileContent(file);
                        // Tronca file troppo grandi per evitare problemi (es. 100KB per file)
                        const maxSize = 100000; // 100KB
                        const contentToSend = contenuto.length > maxSize 
                            ? contenuto.substring(0, maxSize) + "\n... [file troncato per lunghezza]" 
                            : contenuto;
                        
                        contesto += `File: ${file.name}\n\`\`\`\n${contentToSend}\n\`\`\`\n\n`;
                    }
                }

                // Combina contesto e domanda
                const prompt = contesto 
                    ? `${contesto}\n\nRichiesta: ${userMessage || "Analizza questo progetto e forniscimi un feedback generale."}` 
                    : userMessage;

                // Chiamata a Puter.ai con il modello selezionato
                const response = await puter.ai.chat(prompt, {
                    model: modelSelect.value,
                    stream: true
                });

                // Rimuovi indicatore di digitazione
                removeTypingIndicator();

                // Prepara un nuovo messaggio per lo streaming
                const messageDiv = document.createElement('div');
                messageDiv.className = 'message assistant';
                messagesContainer.appendChild(messageDiv);
                
                let fullResponse = '';
                for await (const part of response) {
                    if (part?.text) {
                        fullResponse += part.text;
                        messageDiv.innerHTML = formatMessage(fullResponse);
                        messagesContainer.scrollTop = messagesContainer.scrollHeight;
                    }
                }

            } catch (error) {
                removeTypingIndicator();
                addMessageToChat('assistant', `‚ùå Errore: ${error.message}. Assicurati di aver effettuato il login a Puter quando richiesto.`);
                console.error('Errore Puter.ai:', error);
            } finally {
                setProcessingState(false);
            }
        }

        // Funzione per leggere il contenuto di un file come testo
        function readFileContent(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = (e) => reject(e.target.error);
                reader.readAsText(file);
            });
        }

        // Aggiunge un messaggio alla chat
        function addMessageToChat(role, content) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `message ${role}`;
            messageDiv.innerHTML = formatMessage(content);
            messagesContainer.appendChild(messageDiv);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        // Formatta il messaggio (supporto basico markdown)
        function formatMessage(text) {
            // Converti line breaks in <br> per testuali, ma preserva blocchi di codice
            if (text.includes('```')) {
                // Gestione semplice dei blocchi di codice
                return text.replace(/```(\w*)\n([\s\S]*?)```/g, '<pre><code>$2</code></pre>')
                          .replace(/\n/g, '<br>');
            }
            return text.replace(/\n/g, '<br>');
        }

        function showTypingIndicator() {
            removeTypingIndicator();
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typingIndicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            messagesContainer.appendChild(indicator);
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            currentTypingIndicator = indicator;
        }

        function removeTypingIndicator() {
            if (currentTypingIndicator) {
                currentTypingIndicator.remove();
                currentTypingIndicator = null;
            }
        }

        function setProcessingState(processing) {
            isProcessing = processing;
            sendButton.disabled = processing;
            userInput.disabled = processing;
            if (!processing) {
                userInput.focus();
            }
        }

        function clearChat() {
            if (confirm('Vuoi iniziare una nuova chat? I file caricati rimarranno disponibili.')) {
                messagesContainer.innerHTML = '';
                addMessageToChat('assistant', 'Chat pulita. Sono sempre qui per analizzare il tuo progetto!');
            }
        }

        // Auto-resize della textarea
        userInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = (this.scrollHeight) + 'px';
        });

        // Invio con Enter (ma Shift+Enter per andare a capo)
        userInput.addEventListener('keydown', (e) => {
            if (e.key === 'Enter' && !e.shiftKey) {
                e.preventDefault();
                sendMessage();
            }
        });

        // Inizializza
        window.onload = function() {
            // Focus sull'input
            userInput.focus();
            
            // Opzionale: verifica se Puter √® caricato
            if (typeof puter === 'undefined') {
                addMessageToChat('assistant', '‚ö†Ô∏è Attenzione: Puter.js non √® stato caricato correttamente. Verifica la connessione internet.');
            } else {
                console.log('Puter.js pronto!');
            }
        };

        // Rende disponibile sendMessage globalmente per il bottone
        window.sendMessage = sendMessage;
        window.clearChat = clearChat;
    </script>
</body>
</html>